name: MacOS-CI
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build_and_test:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macOS-13
            build-type: RelWithDebInfo
            preset-name: macos-pie-enabled-RelWithDebInfo
            python-version: 3.13.3

    steps:
      - name: Python Setup on Mac
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        id: vega-py-setup
        with:
          python-version: ${{ matrix.python-version }}
          update-environment: false # true

      - name: Install dependencies using homebrew
        run: brew install boost-python3
        
      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: install-cmake
        uses: lukka/get-cmake@57c20a23a6cac5b90f31864439996e5b206df9dc # v4.0.1
        with:
          cmakeVersion: 4.0.1
          ninjaVersion: 1.12.1

      - name: run-build-script
        working-directory: ${{ github.workspace }}
        env:
          MY_OS_NAME: macos
          Python3_ROOT_DIR: ${{ matrix.vega-py-setup.outputs.python-path }}
          Python_ROOT_DIR: ${{ matrix.vega-py-setup.outputs.python-path }}
          pythonLocation: ${{ matrix.vega-py-setup.outputs.python-path }}
          PYTHONHOME: ""
          PYTHONPATH: ""
        run: pwsh ./script/build.ps1 -PresetName ${{ matrix.preset-name }} -BuildType ${{ matrix.build-type }}
